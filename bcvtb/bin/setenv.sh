#!/bin/bash
##############################################################
# This file sets environment variables for the BCVTB.
# 
# To run it, change to top level directory of the BCVTB and
# type
#  source bin/setenv.sh
# To force reseting variables, use
#  source bin/setenv.sh -f
#
# MWetter@lbl.gov                                   2008-07-15
##############################################################

##############################################################
# Don't run script twice, unless forced to do so
if [ "$1" != "-f" ]; then
    if test ${BCVTBEnvSet}; then
	echo "BCVTB environment already set. Doing nothing."
	echo "To set again, use 'source bin/setenv.sh -f'"
	return 1
    fi
else
    echo "Forcing reset of environment variables."
fi

##############################################################
# Ensure that we are in the top level directory of the BCVTB
# This is needed since we use the pwd command
if test ! "`ls bin/setenv.sh 2> /dev/null`"; then
	echo "Error: Script bcvbt.sh must be run from root directory"
        echo "       of the BCVTB and not from `pwd`"
        echo "       Exit with error."
	return 1
fi


# Set EnergyPlus version
BCVTB_EP_VERSION=3.1

PROPERTYFILE=build.properties
BCVTBUSEMS=true # Set to true to use Microsoft compiler, set to false to use cygwin

##############################################################
# Test if software is present, and set environment variables
# Check for vergil
if test "x" == "x`which vergil`"; then
    echo "Error: Did not find vergil which is needed to run Ptolemy."  
    echo "       Did you install Ptolemy correctly?"
    echo "       Exit with error."
    return 1
fi

if test "x" == "x$PTII"; then
    echo "Error: Environment variable PTII is not set."  
    echo "       Add it to ~/.bashrc or ~/.profile"
    echo "       Exit with error."
    return 1
fi


# Check for ifort
if test ! "`which ifort 2> /dev/null`"; then
    echo "Fortran compiler not found: ifort."
    echo "  If Fortran is installed, make sure 'ifort' is on path."
fi

# Check for matlab
if test ! "`which matlab 2> /dev/null`"; then
    echo "Matlab not found."
    echo "  If Matlab is installed, make sure 'matlab' is on path."
fi

##############################################################
# Set directories

# top level directory of the BCVTB
BCVTB_HOME=`pwd`

# MATLAB/Simulink libraries path
# This works for Mac OS X and Linux, but MATLABPATH leads
# to an error on Windows.
MATLABPATH=$MATLABPATH:$BCVTB_HOME/lib/matlab

# Java CLASSPATH
CLASSPATH=$BCVTB_HOME/lib:${PTII}:$CLASSPATH:$BCVTB_HOME/lib/cpptasks.jar

# EnergyPlus directory
ENERGYPLUS_DIR=$BCVTB_HOME/clients/ep-${BCVTB_EP_VERSION}

# Ptolemy binary directory
PATH=${PTII}/bin:${PATH}

##############################################################
# System dependent environment variables
case `uname` in
    Linux)
	export LD_LIBRARY_PATH=$BCVTB_HOME/lib/util:$LD_LIBRARY_PATH
	PATH=$ENERGYPLUS_DIR/bin-linux:$PATH
#       Set path to dynamic library.
#       This avoids a runtime error in matlab because of
#       an 'undefined symbol: gzopen64' on Ubuntu 7.10 and 8.04
	export LD_LIBRARY_PATH=$BCVTB_HOME/lib-ubuntu-7.10:$LD_LIBRARY_PATH
	BCVTB_OS=linux
    ;;
    Darwin)
	export DYLD_LIBRARY_PATH=$BCVTB_HOME/lib/util:$DYLD_LIBRARY_PATH
	PATH=$ENERGYPLUS_DIR/bin-mac:$PATH
	BCVTB_OS=mac
    ;;*)
    	echo "setenv.sh: Unknown operating system: `uname`"
esac

##############################################################
# Set properties for ant build file
echo "// This file was autogenerated by $user on `date`" > $PROPERTYFILE
echo "// Changes to this file will be lost whenever" >> $PROPERTYFILE
echo "// bin/setenv.sh is executed."  >> $PROPERTYFILE
if test "`which ifort 2> /dev/null`"; then
    echo haveIfort=true >> $PROPERTYFILE
fi
if test "`which matlab 2> /dev/null`"; then
    echo haveMatlab=true >> $PROPERTYFILE
fi
if [ -d "${ENERGYPLUS_DIR}" ]; then
    echo haveEnergyPlus=true >> $PROPERTYFILE
fi
if test "`which doxygen 2> /dev/null`"; then
    echo haveDoxygen=true >> $PROPERTYFILE
fi

# Dymola is only supported on Windows
echo haveDymola=false >> $PROPERTYFILE

##############################################################
# Export variables
export BCVTBEnvSet="true"
export CLASSPATH
export ENERGYPLUS_DIR
export PATH
export BCVTB_HOME
export MATLABPATH
# BCVTB_OS is needed by matlab to deterine the library names on Linux
export BCVTB_OS 